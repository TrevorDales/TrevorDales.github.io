<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
        Lab 5: Linear PID Control
    </title><link href="https://TrevorDales.github.io/ atom.xml" title="Trevor Dales" rel=alternate type=application/atom+xml><link href=https://TrevorDales.github.io/main.css media=screen rel=stylesheet><meta content="Hi! My name is Trevor." name=description><meta content="Hi! My name is Trevor." name=description><meta content="index, nofollow" name=robots><meta content="Trevor Dales" property=og:title><meta content=article property=og:type><meta content=https://TrevorDales.github.io/MAE4190/lab5/ property=og:url><meta content="Hi! My name is Trevor." property=og:description><meta content="Trevor Dales" property=og:site_name><meta content="default-src 'self' ws://127.0.0.1:1024/; img-src 'self' https://*; script-src 'self'; style-src 'self'; font-src 'self'; frame-src https://www.youtube.com https://player.vimeo.com;" http-equiv=Content-Security-Policy><body><header><div class=navbar><div class="nav-title nav-navs"><a class="nav-links home-title" href=https://TrevorDales.github.io>Trevor Dales</a></div><nav class="nav-title nav-navs"><a class=nav-links href=/MAE4190> <img 4190 alt=MAE height=15 src=/menu_icon/projects.png width=15> MAE 4190</a><a class=nav-links href=/contact/contact> <img alt=Contact height=15 src=/menu_icon/resume.png width=15> Contact</a></nav><nav class="socials nav-navs"><label class=theme-switcher for=themeswitch><div class=background></div> <input id=themeswitch type=checkbox> <div class=switch><img alt="theme switch to dark" class=moon src=/menu_icon/moon.png><img alt="theme switch to light" class=sun src=/menu_icon/sun.png></div></label></nav></div></header><div class=content><main><article><div class=title><h2>Lab 5: Linear PID Control</h2><div class=meta>Posted on <time>2025-03-10</time></div></div><section class=body><h1 id=code-structure>Code Structure</h1><p>To execute a PID-controlled movement, I established communication between my laptop and my robot as follows:<ul><li><p>Functions were created on the Artemis for controlling the motors and collecting sensor data, allowing them to be called as needed.</p><li><p>A BLE command initiates the PID-controlled motion, which runs for 5 seconds while sensor and PID data arrays are populated.</p><li><p>Additional BLE commands transfer the recorded data from the Artemis to my laptop for plotting and analysis.</p></ul><p>Before implementing any controller logic, I made sure to get this data flow working. This allowed me to efficiently debug and tune my controller. <br> <br><h1 id=range-samping-time>Range/Samping Time</h1><p>I set my TOF sensor mode to long to ensure proper controller behavior when the robot was still far from the wall. I also lowered the timing budget on the sensors to try to get more speed out of them.<pre class=z-code><code><span class="z-text z-plain">distanceSensor2.setDistanceModeLong();
</span><span class="z-text z-plain">distanceSensor2.setTimingBudgetInMs(35);
</span><span class="z-text z-plain">distanceSensor2.setIntermeasurementPeriod(40);
</span></code></pre><br><br><h1 id=proportional-control>Proportional control</h1><p>I began by implementing a simple proportional controller. While I was able to get this logic working, it had some key issues:<ul><li>The controller had significant under/overshoot depending on the proportional gain.<li>The target could only be reached when the car was travelling relatively slow.</ul><p>I was able to improve the end behavior by implementing some clamping logic - this code snippet pulls up low speed values to ensure the deadband of the motor does not keep the car from making small adjustments when it is near the target.<pre class=z-code><code><span class="z-text z-plain">// Pull input up to upper floor if it is not too low, considering negative values
</span><span class="z-text z-plain">if (control_input > -pid_lower_floor && control_input < pid_lower_floor) {
</span><span class="z-text z-plain">    control_input = 0;
</span><span class="z-text z-plain">} else if (control_input >= pid_lower_floor && control_input < pid_upper_floor) {
</span><span class="z-text z-plain">    control_input = pid_upper_floor;
</span><span class="z-text z-plain">} else if (control_input <= -pid_lower_floor && control_input > -pid_upper_floor) {
</span><span class="z-text z-plain">    control_input = -pid_upper_floor;
</span><span class="z-text z-plain">}
</span></code></pre><br> The result: <div align=center><iframe <pre class=z-code height=315 src=https://www.youtube.com/embed/aaNj672BtfY width=175><code><span class="z-text z-plain">allowfullscreen> </span></code></iframe><img src=/Lab5/P_control.png style=display:block><h5 id=getting-to-this-result-took-considerable-tuning-of-both-the-proportional-gain-as-well-as-the-floor-inputs-that-deal-with-the-motor-deadband-improperly-tuned-parameters-lead-to-overshoot-or-a-car-that-doesn-t-move-at-all-the-overshoot-could-be-reduced-by-lowering-the-gain-but-this-would-mean-a-slower-rise-time-i-settled-on-a-kp-of-about-1-here>Getting to this result took considerable tuning of both the proportional gain as well as the floor inputs that deal with the motor deadband. Improperly tuned parameters lead to overshoot or a car that doesn't move at all. The overshoot could be reduced by lowering the gain, but this would mean a slower rise time. I settled on a Kp of about 1 here.</h5></div><br><br><h1 id=pd-control>PD control</h1><p>In order to better deal with the overshoot, as well as to allow me to run my robot faster, I decided to implement derivative control. I achieved this by keeping track of the previous error and previous time so I could calculate how the error was changing with time.<pre class=z-code><code><span class="z-text z-plain">static float prev_error = 0; // Store previous error
</span><span class="z-text z-plain">static unsigned long prev_time = millis(); // Store previous timestamp
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">unsigned long current_time = millis();
</span><span class="z-text z-plain">float dt = (current_time - prev_time) / 1000.0; // Convert to seconds
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">pid_d[pidCounter] = kd * (e - prev_error) / dt;
</span></code></pre><br><p>I also the following piece of logic to deal with the fact that my PD logic was running much faster than my sensor data was coming in. Basically, this prevents the derivative term from thinking there is zero error when the PD error is calculated without a new TOF datapoint.<pre class=z-code><code><span class="z-text z-plain">if (pid_d[pidCounter] == 0){
</span><span class="z-text z-plain">    pid_d[pidCounter] = last_d;
</span><span class="z-text z-plain">}
</span><span class="z-text z-plain">else{
</span><span class="z-text z-plain">    last_d = pid_d[pidCounter];
</span><span class="z-text z-plain">}
</span></code></pre><br><p>The results of this were very clear - the overshoot was now gone, and I was able to bump up Kp for a faster rise time. Any extra overshoot could be compensated for with a greater Kd.<div align=center><iframe <pre class=z-code height=315 src=https://www.youtube.com/embed/MpxRXC12IjY width=175><code><span class="z-text z-plain">allowfullscreen> </span></code></iframe><img src=/Lab5/PD_control.png style=display:block><h5 id=kp-of-2-kd-of-0-4>Kp of 2, Kd of 0.4</h5></div><br><br><h1 id=extrapolation>Extrapolation</h1><p>To get even better performance, I want to do something about the TOF sampling rate. I have already written my controller logic to be independent of the sensors, so the data is coming in much slower than the PD logic is running. If I can estimate what the data points will be before I actually receive them, my system won't be as limited by this slow sensor speed. Here is the code I used to calculate the slope and extrapolated data:<pre class=z-code><code><span class="z-text z-plain">if (new_data){    
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">    current_distance =  tof2_array[tof2Counter - 1];
</span><span class="z-text z-plain">    tof2_extrapolated_array[pidCounter] = current_distance;
</span><span class="z-text z-plain">    new_data = 0;
</span><span class="z-text z-plain">    } else {
</span><span class="z-text z-plain">        // extrapolate next data point
</span><span class="z-text z-plain">        float dt = millis() - pid_time_stamps[pidCounter - 1];
</span><span class="z-text z-plain">        float speed = ( tof2_array[tof2Counter - 1] - tof2_array[tof2Counter - 2] ) / (tof2_time_stamps[tof2Counter - 1] - tof2_time_stamps[tof2Counter - 2] ); //slope
</span><span class="z-text z-plain">        current_distance = tof2_extrapolated_array[pidCounter - 1] + speed*dt;
</span><span class="z-text z-plain">        tof2_extrapolated_array[pidCounter] = current_distance;
</span><span class="z-text z-plain">    }
</span></code></pre><p>Honestly, my results didn't exactly improve. Looking at the extrapolated data, it looks choppy when compared to the original data. This causes some oscillatory/inconsistent motion in my robot. There is likely an issue in my code, but I haven't been able to find it. The derivative control is spiking wildly, but I've spent lots of time debugging and I haven't figured it out yet.<div align=center><iframe <pre class=z-code height=315 src=https://www.youtube.com/embed/G5dnDsUw41g width=175><code><span class="z-text z-plain">allowfullscreen> </span></code></iframe><img src=/Lab5/tofdata.png style=display:block><img src=/Lab5/interp.png style=display:block><h5 id=still-kind-of-works-but-derivative-control-is-definitely-not-working-as-intended>Still kind of works, but derivative control is definitely not working as intended.</h5></div></section></article></main></div><footer><section><nav><a class="nav-links social" rel="noopener noreferrer" href=https://github.com/TrevorDales target=_blank> <img alt=github src=/social_icons/github.svg title=github> </a></nav><nav><span classname=desktop-only>This blog is powered by <a rel="noopener noreferrer" href=https://getzola.org/ target=_blank>Zola</a> with theme by <a rel="noopener noreferrer" href=https://syedzayyan.com/ target=_blank>SZM</a></span></nav></section><script src=https://TrevorDales.github.io/js/main.js></script></footer>